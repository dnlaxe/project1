<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Annotator</title>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #toolbar {
      margin-bottom: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
    }
    #container {
      border: 1px solid #ccc;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }
    canvas {
      cursor: crosshair;
      touch-action: none; /* Prevent browser gestures */
    }
    .tool-group {
      display: inline-block;
      margin-right: 20px;
    }
    .tool-group label {
      margin-right: 5px;
    }
    .tool-button {
      padding: 5px 10px;
      margin-right: 5px;
      border: 1px solid #aaa;
      background-color: #f5f5f5;
      cursor: pointer;
    }
    .tool-button.active {
      border: 2px solid #000;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <input type="file" id="imageLoader" accept="image/*" />

    <div class="tool-group">
      <label>Color:</label>
      <button class="tool-button color" data-color="green" style="background-color: green;"></button>
      <button class="tool-button color" data-color="blue" style="background-color: blue;"></button>
      <button class="tool-button color" data-color="orange" style="background-color: orange;"></button>
    </div>

    <div class="tool-group">
      <label>Thickness:</label>
      <button class="tool-button thickness" data-size="2">Thin</button>
      <button class="tool-button thickness" data-size="5">Middle</button>
      <button class="tool-button thickness" data-size="10">Thick</button>
    </div>

    <div class="tool-group">
      <label>
        <input type="checkbox" id="shadowToggle" />
        Shadow
      </label>
    </div>

    <button id="fullscreenBtn" class="tool-button">Fullscreen</button>
  </div>

  <div id="container"></div>

  <script>
    const stage = new Konva.Stage({
      container: 'container',
      width: window.innerWidth,
      height: 600,
      draggable: false  // Prevent moving the canvas
    });

    const imageLayer = new Konva.Layer();
    const drawLayer = new Konva.Layer();
    stage.add(imageLayer);
    stage.add(drawLayer);

    let isDrawing = false;
    let currentLine = null;

    let currentColor = 'green';
    let currentThickness = 2;
    let shadowEnabled = false;

    // Stylus-only mode when in fullscreen
    let stylusOnlyMode = false;

    document.addEventListener('fullscreenchange', () => {
      stylusOnlyMode = !!document.fullscreenElement;
    });

    function isStylusEvent(evt) {
      return evt.pointerType === 'pen';
    }

    function stylusGuard(evt) {
      if (stylusOnlyMode && evt.pointerType !== 'pen') {
        evt.preventDefault();
        evt.stopImmediatePropagation();
        return false;
      }
    }

    // Prevent finger scroll/gesture in fullscreen
    document.addEventListener('touchstart', (e) => {
      if (stylusOnlyMode) e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      if (stylusOnlyMode) e.preventDefault();
    }, { passive: false });

    // Block finger interaction on toolbar
    document.getElementById('toolbar').addEventListener('pointerdown', (e) => {
      stylusGuard(e);
    }, true);

    // Drawing handlers
    stage.on('pointerdown', (e) => {
      if (stylusGuard(e.evt) === false) return;

      isDrawing = true;
      const pos = stage.getPointerPosition();

      currentLine = new Konva.Line({
        stroke: currentColor,
        strokeWidth: currentThickness,
        globalCompositeOperation: 'source-over',
        points: [pos.x, pos.y],
        lineCap: 'round',
        lineJoin: 'round',
        draggable: false,
        ...(shadowEnabled && {
          shadowColor: currentColor,
          shadowBlur: 5,
          shadowOffset: { x: 2, y: 2 },
          shadowOpacity: 0.6,
        }),
      });

      drawLayer.add(currentLine);
    });

    stage.on('pointermove', (e) => {
      if (stylusGuard(e.evt) === false || !isDrawing || !currentLine) return;

      const pos = stage.getPointerPosition();
      const newPoints = currentLine.points().concat([pos.x, pos.y]);
      currentLine.points(newPoints);
      drawLayer.batchDraw();
    });

    stage.on('pointerup', (e) => {
      if (stylusGuard(e.evt) === false) return;
      isDrawing = false;
      currentLine = null;
    });

    // Image loader
    document.getElementById('imageLoader').addEventListener('change', function (e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function (evt) {
        const img = new Image();
        img.onload = function () {
          const containerWidth = window.innerWidth - 20;
          const scale = containerWidth / img.width;
          const scaledWidth = containerWidth;
          const scaledHeight = img.height * scale;

          stage.width(scaledWidth);
          stage.height(scaledHeight);

          imageLayer.destroyChildren();

          const konvaImage = new Konva.Image({
            image: img,
            x: 0,
            y: 0,
            width: scaledWidth,
            height: scaledHeight,
            draggable: false
          });

          imageLayer.add(konvaImage);
          imageLayer.draw();
        };
        img.src = evt.target.result;
      };

      reader.readAsDataURL(file);
    });

    // Tool selectors
    function setActiveButton(buttons, selectedButton) {
      buttons.forEach(btn => btn.classList.remove('active'));
      selectedButton.classList.add('active');
    }

    const colorButtons = Array.from(document.querySelectorAll('.tool-button.color'));
    colorButtons.forEach(btn => {
      btn.addEventListener('pointerdown', (e) => {
        if (stylusGuard(e) === false) return;
        currentColor = btn.dataset.color;
        setActiveButton(colorButtons, btn);
      });
    });
    setActiveButton(colorButtons, colorButtons[0]);

    const thicknessButtons = Array.from(document.querySelectorAll('.tool-button.thickness'));
    thicknessButtons.forEach(btn => {
      btn.addEventListener('pointerdown', (e) => {
        if (stylusGuard(e) === false) return;
        currentThickness = parseInt(btn.dataset.size);
        setActiveButton(thicknessButtons, btn);
      });
    });
    setActiveButton(thicknessButtons, thicknessButtons[0]);

    // Shadow toggle
    document.getElementById('shadowToggle').addEventListener('change', function (e) {
      if (stylusGuard(e) === false) {
        e.target.checked = !e.target.checked; // revert if blocked
        return;
      }
      shadowEnabled = e.target.checked;
    });

    // Fullscreen button
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const elem = document.documentElement;
      if (!document.fullscreenElement) {
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    });
  </script>
</body>
</html>
