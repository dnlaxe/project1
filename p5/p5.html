<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exploding and Reassembling Cube</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script>
    let exploded = false;
    let pieces = [];
    let explosionTime = 0;
    const floatDuration = 5000; // 5 seconds

    function setup() {
      createCanvas(windowWidth, windowHeight, WEBGL);
    }

    function draw() {
      background(10);
      rotateY(millis() / 3000);
      rotateX(millis() / 5000);

      if (!exploded) {
        fill(150, 255, 200);
        box(100);
      } else {
        let elapsed = millis() - explosionTime;
        let reassembling = elapsed > floatDuration;

        let allCentered = true;
        for (let p of pieces) {
          push();
          translate(p.pos.x, p.pos.y, p.pos.z);
          fill(p.color);
          box(p.size);
          if (!reassembling) {
            p.floatAround();
          } else {
            p.returnToOrigin();
            if (!p.atOrigin()) {
              allCentered = false;
            }
          }
          pop();
        }

        // Reset state if fully reassembled
        if (reassembling && allCentered) {
          exploded = false;
          pieces = [];
        }
      }
    }

    function mousePressed() {
      if (!exploded) {
        explode();
        exploded = true;
        explosionTime = millis();
      }
    }

    function explode() {
      const num = 5;
      const spacing = 100 / num;
      for (let x = -2; x <= 2; x++) {
        for (let y = -2; y <= 2; y++) {
          for (let z = -2; z <= 2; z++) {
            let originalPos = createVector(x * spacing, y * spacing, z * spacing);
            let pos = originalPos.copy();
            let vel = p5.Vector.random3D().mult(random(1, 3));
            pieces.push(new Piece(pos, vel, spacing * 0.8, originalPos));
          }
        }
      }
    }

    class Piece {
      constructor(pos, vel, size, origin) {
        this.pos = pos.copy();
        this.vel = vel.copy();
        this.size = size;
        this.origin = origin.copy();
        this.color = color(random(255), random(255), random(255));
      }

      floatAround() {
        this.pos.add(this.vel);
        let jitter = p5.Vector.random3D().mult(0.05);
        this.vel.add(jitter).limit(3);
      }

      returnToOrigin() {
        let dir = p5.Vector.sub(this.origin, this.pos);
        this.pos.add(dir.mult(0.1)); // smooth transition back
      }

      atOrigin() {
        return p5.Vector.dist(this.pos, this.origin) < 0.5;
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
